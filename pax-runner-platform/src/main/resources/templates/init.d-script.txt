#!/bin/bash
#
# init.d script to manage a container based on an OSGi framework
#
# Generated by PAX Runner
#
set -e # stop on errors
#
#              <startlevels> <startprio> <stopprio>
# chkconfig:   2345 80 80
# description: The PAX_RUNNER_APPNAME application
#
# NOTE: the 2 comments above and the following 4 variable values will probably
#       need customization when packaging the distribution. The generated values
#       are meant for local testing
#

app_user=$USER
app_name=PAX_RUNNER_APPNAME
app_root=/opt/$app_name
pid_file=/var/run/${app_name}.pid
log_file=/var/log/${app_name}/runner.log

if [[ -f /etc/$app_name/$app_name.rc ]]; then
    . /etc/$app_name/$app_name.rc
fi

#
# ... here we go ...
#
# - get PID from .pid file if it exists and check if it is running
#
pid=`[[ -e ${pid_file} ]] && cat ${pid_file} || echo "NO_PID_FILE"`
set +e # disable because egrep will return 1 on mismatch
pid_isrunning=`ps -eo pid | egrep ^[[:space:]]*${pid}$`
set -e # reenable
#
# - functions to start/stop the container ...
#
function startContainer() {
  if [ -z ${pid_isrunning} ]; then
    echo "starting ${app_name}"

    if [[ "${app_user}" == "root" ]]; then
        echo "running as root is not allowed, please define app_user in /etc/$app_name/$app_name.rc"
        exit 1
    fi

    touch ${log_file}
    touch ${pid_file}
    chown ${app_user} ${log_file}
    chown ${app_user} ${pid_file}

    pushd ${app_root} > /dev/null
PAX_RUNNER_STARTCODE
    popd > /dev/null
  else
    echo "${app_name} already running with pid ${pid}"
  fi
}
#
function stopContainer() {
  if [ ! -z ${pid_isrunning} ]; then
    echo -n "stopping ${app_name} with pid ${pid}"
    kill $pid

    while kill -0 $pid 2>/dev/null
    do
        echo -n "."
        sleep 1
    done
    echo ""

  else
    echo "${app_name} not running"
  fi
}
#
# - main command dispatch ...
#
case "$1" in
    start)
      startContainer
      ;;
    stop)
      stopContainer
      ;;
    restart)
      stopContainer
      startContainer
      ;;
    status)
      if [ ! -z ${pid_isrunning} ]; then
        echo "${app_name} is running with pid ${pid}"
      else
        echo "${app_name} not running"
      fi
      ;;
    *)
      echo "Usage: ${app_name} {start|stop|restart|status}"
      exit 1
      ;;
esac
#
exit 0
